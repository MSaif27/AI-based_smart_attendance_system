{% extends 'base.html' %}
{% block page_title %}Edit Student{% endblock %}
{% block content %}
<div class="row g-4">
<div class="col-md-7"><div class="glass-card"><div class="card-head"><i class="fas fa-edit"></i> Edit â€” {{ student.name }}</div>
<div class="card-body-pad"><form method="post" enctype="multipart/form-data" id="edit-form">
{% csrf_token %}<input type="hidden" name="webcam_photo" id="webcam-photo-data">
<div class="row g-3">
<div class="col-md-6"><label class="form-label">Full Name</label>{{ student_form.name }}</div>
<div class="col-md-6"><label class="form-label">Roll Number</label>{{ student_form.roll_number }}</div>
<div class="col-md-6"><label class="form-label">Email</label>{{ student_form.email }}</div>
<div class="col-md-6"><label class="form-label">Parent Email</label>{{ student_form.parent_email }}</div>
<div class="col-md-4"><label class="form-label">Phone</label>{{ student_form.phone }}</div>
<div class="col-md-4"><label class="form-label">Section</label>{{ student_form.section }}</div>
<div class="col-md-4"><label class="form-label">Semester</label>{{ student_form.semester }}</div>
</div>
<div class="d-flex gap-3 mt-4">
<button type="submit" class="btn-maroon" style="padding:12px 28px;">Save Changes</button>
<a href="{% url 'student_list' %}" class="btn-ghost" style="padding:12px 20px;">Cancel</a>
</div>
</form></div></div></div>
<div class="col-md-5"><div class="glass-card"><div class="card-head"><i class="fas fa-camera"></i> Update Face Photo</div>
<div class="card-body-pad">
{% if student.photo %}<img src="{{ student.photo.url }}" style="width:100%;border-radius:12px;margin-bottom:16px;max-height:200px;object-fit:cover;">{% endif %}
<div class="d-flex gap-2 mb-3">
<button onclick="showCamPanel()" class="btn-maroon" style="flex:1;padding:9px;">Webcam</button>
<button onclick="showUploadPanel()" class="btn-ghost" style="flex:1;padding:9px;">Upload</button>
</div>
<div id="cam-panel" style="display:none;">
<video id="edit-video" autoplay playsinline style="width:100%;border-radius:10px;display:none;"></video>
<div id="edit-placeholder" style="text-align:center;padding:30px;color:var(--text-muted);">
<i class="fas fa-camera" style="font-size:36px;opacity:0.3;display:block;margin-bottom:8px;"></i>Click Start
</div>
<img id="edit-captured" src="" style="display:none;width:100%;border-radius:10px;">
<div class="d-flex gap-2 mt-2">
<button onclick="startEditCam()" id="e-start" class="btn-gold" style="flex:1;padding:8px;font-size:13px;">Start</button>
<button onclick="captureEditPhoto()" id="e-capture" class="btn-maroon" style="flex:1;padding:8px;font-size:13px;display:none;">Capture</button>
<button onclick="retakeEditPhoto()" id="e-retake" class="btn-ghost" style="flex:1;padding:8px;font-size:13px;display:none;">Retake</button>
</div>
</div>
<div id="upload-panel" style="display:none;">{{ student_form.photo }}</div>
<div id="face-msg" style="margin-top:10px;"></div>
</div></div></div>
</div>
{% endblock %}
{% block extra_js %}
<script>
let es = null;
function showCamPanel(){document.getElementById('cam-panel').style.display='block';document.getElementById('upload-panel').style.display='none';}
function showUploadPanel(){document.getElementById('cam-panel').style.display='none';document.getElementById('upload-panel').style.display='block';}
async function startEditCam(){
es=await navigator.mediaDevices.getUserMedia({video:true});
const v=document.getElementById('edit-video');v.srcObject=es;v.style.display='block';
document.getElementById('edit-placeholder').style.display='none';
document.getElementById('e-start').style.display='none';
document.getElementById('e-capture').style.display='block';
}
function captureEditPhoto(){
const v=document.getElementById('edit-video');
const c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;
c.getContext('2d').drawImage(v,0,0);
const d=c.toDataURL('image/jpeg',0.9);
document.getElementById('webcam-photo-data').value=d;
document.getElementById('edit-captured').src=d;
document.getElementById('edit-captured').style.display='block';
v.style.display='none';
if(es)es.getTracks().forEach(t=>t.stop());
document.getElementById('e-capture').style.display='none';
document.getElementById('e-retake').style.display='block';
document.getElementById('face-msg').innerHTML='<div class="smart-alert success" style="font-size:12px;margin-top:8px;">Photo captured!</div>';
}
function retakeEditPhoto(){
document.getElementById('edit-captured').style.display='none';
document.getElementById('webcam-photo-data').value='';
document.getElementById('e-retake').style.display='none';
document.getElementById('e-start').style.display='block';
document.getElementById('edit-placeholder').style.display='block';
document.getElementById('face-msg').innerHTML='';
}
</script>
{% endblock %}
